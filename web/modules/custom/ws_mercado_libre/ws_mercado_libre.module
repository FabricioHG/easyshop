<?php

/**
 * @file
 * Primary module hooks for WS Mercado Libre module.
 */

function ws_mercado_libre_form_commerce_product_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id){
	$base_form = $form_state->getBuildInfo()['base_form_id'];
	$form['#attached']['library'][] = 'ws_mercado_libre/ws_mercado_libre.callajax';
 	
	//Obtener el valor del campo de cada usuario para saber si quiere publicar en ML
	// $storage_user = \Drupal::entityTypeManager()->getStorage('user');
	// $current_user_id = \Drupal::currentUser()->id();
	// $node_user = $storage_user->load($current_user_id);
	// $publicar_en_ml = $node_user->get('field_publish_products')->value;

	// if($publicar_en_ml === "1"){
	// 	//obtener campos obligatorios (atributos)
	// 	$servicio_ml = \Drupal::service('ws_mercado_libre.mercadolibre_service');
	// 	$categoria_sugerida = $servicio_ml->predecir_categoria('titulo');
	// 	$atributos_obligatorios = $servicio_ml->obtener_attr_obligatorios('categoria_predecida');


	// }
	$form['div_prueba']=[
 		'#type' => 'container',
 		'#markup' => "<div class='div-ajax'>elemento 1</div>",
 		'#attributes' => ['id' => 'divPrueba'],
 	];

 	$form['title']['widget'][0]['value']['#ajax']=[
 		'callback' => 'backCategoria',
		'wrapper' => 'divPrueba',
		'event' => 'blur',
		'progress' => [
        	'type' => 'throbber',
        	'message' => 'Prediciendo categoria...',
    	],

 	];    

}

function backCategoria(array &$form, \Drupal\Core\Form\FormStateInterface $form_state) {
     $titulo = $form_state->getValue('title')[0]['value'];
     $categorias = \Drupal::service('ws_mercado_libre.mercadolibre_service')->predecir_categoria($titulo);

     $contenido_variable = print_r($categorias,true);

    // // Realiza el procesamiento y devuelve un elemento del formulario.
	\Drupal::logger('ws_mercado_libre')->notice('contenido de variable %titulo',['%titulo'=>$contenido_variable ]); // Registra un mensaje en el registro de Drupal.
   

    $form['div_prueba']['#markup']="<div class='div-ajax'>elemento 2</div>";

     return $form['div_prueba'];
}
