<?php

/**
 * @file
 * Primary module hooks for WS Mercado Libre module.
 */

function ws_mercado_libre_form_commerce_product_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id){
	$base_form = $form_state->getBuildInfo()['base_form_id'];
	$form['#attached']['library'][] = 'ws_mercado_libre/ws_mercado_libre.callajax';
 	
	//Obtener el valor del campo de cada usuario para saber si quiere publicar en ML
	 $storage_user = \Drupal::entityTypeManager()->getStorage('user');
	 $current_user_id = \Drupal::currentUser()->id();
	 $node_user = $storage_user->load($current_user_id);
	 $publicar_en_ml = $node_user->get('field_publish_products')->value;

	if($publicar_en_ml === "1"){
		//obtener campos obligatorios (atributos)
	 	$servicio_ml = \Drupal::service('ws_mercado_libre.mercadolibre_service');

	 	/*Hacer que el titulo funcione con ajax*/
	 	$form['title']['widget'][0]['value']['#ajax']=[
	 		'callback' => 'backCategoria',
			'wrapper' => 'selec_categoria_ml',
			'event' => 'blur',
			'progress' => [
	        	'type' => 'throbber',
	        	'message' => 'Prediciendo categoria...',
	    	],

	 	];   

	 	//Hacer contenedor de campos de mercado libre
 		$form['data_categoria_ml']=[
 			'#type'=>'fieldset',
 			'#title'=>'Datos para anuncion en Mercado libre',
 		];
 		$form['data_categoria_ml']['categoria_ml'] = [
 			'#type'=> 'select',
 			'#title'=> 'Categoria en Mercado libre',
 			'#option' => [],
 			'#id'=> 'selec_categoria_ml'
 		];


	}

}

function backCategoria(array &$form, \Drupal\Core\Form\FormStateInterface $form_state) {
     $titulo = $form_state->getValue('title')[0]['value'];
     $service_ml = \Drupal::service('ws_mercado_libre.mercadolibre_service');
     $categorias = $service_ml->predecir_categoria($titulo);

     //Revisar que tiene la variable en informes
     $contenido_variable = print_r($categorias,true);

    // // Realiza el procesamiento y devuelve un elemento del formulario.
	\Drupal::logger('ws_mercado_libre')->notice('contenido de variable %titulo',['%titulo'=>$contenido_variable ]); // Registra un mensaje en el registro de Drupal.
   

    $form['categoria_ml']['#option']=$contenido_variable;

     return $form['categoria_ml'];
}
